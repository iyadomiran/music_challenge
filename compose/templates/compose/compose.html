{% load static %}
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Pitch Master</title>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- å¤–éƒ¨CSS -->
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link rel="stylesheet" href="{% static 'css/steps.css' %}">
</head>
<body class="game">
    <div class="container">
        <h2>ğŸ¤  -------  Training Mode -------  ğŸ¤</h2>

        <!-- ã‚¹ãƒ†ãƒƒãƒ—1 -->
        <div class="step-row">
            <span class="step-button">ã‚¹ãƒ†ãƒƒãƒ—1</span>
            <span class="step-text">æŒ‘æˆ¦ã™ã‚‹ãƒ¬ãƒ™ãƒ«ã‚’é¸ã¼ã†ã€‚ â˜…ã€ãƒ¬ãƒ™ãƒ«ã€‘å‡ºé¡Œã•ã‚Œã‚‹éŸ³åŸŸ</span>
        </div>

        <div class="difficulty">
            <label><input type="radio" name="level" value="beginner" checked> ã€ ãƒ¬ãƒ™ãƒ«1 ã€‘<span class="mid-text">ä¸­éŸ³</span>1éŸ³</label>
            <label><input type="radio" name="level" value="intermediate"> ã€ ãƒ¬ãƒ™ãƒ«2 ã€‘<span class="high-text">é«˜éŸ³</span>2éŸ³</label>
            <label><input type="radio" name="level" value="advanced"> ã€ ãƒ¬ãƒ™ãƒ«3 ã€‘<span class="mid-text">ä¸­éŸ³</span>2éŸ³ â†’ <span class="high-text">é«˜éŸ³</span>2éŸ³</label>
        </div>

        <!-- ã‚¹ãƒ†ãƒƒãƒ—2 -->
        <div class="step-row">
            <span class="step-button">ã‚¹ãƒ†ãƒƒãƒ—2</span>
            <span class="step-text">åŸºæº–éŸ³ "ãƒ‰" ã‚’è´ã“ã†ã€‚<br>
                â˜… ãƒ¬ãƒ™ãƒ«1 â†’ <span class="mid-text">ä¸­éŸ³</span> ã€ãƒ¬ãƒ™ãƒ«2 â†’ <span class="high-text">é«˜éŸ³</span> ã€ãƒ¬ãƒ™ãƒ«3 â†’ <span class="mid-text">ä¸­éŸ³</span>ã¨<span class="high-text">é«˜éŸ³</span>ã©ã¡ã‚‰ã‚‚è´ãã€‚
            </span>
        </div>

        <div class="controls">
            <button id="playMid"><span class="mid-text">ä¸­éŸ³</span>ã®åŸºæº–éŸ³ "ãƒ‰" ã‚’è´ã</button>
            <button id="playHigh"><span class="high-text">é«˜éŸ³</span>ã®åŸºæº–éŸ³ "ãƒ‰" ã‚’è´ã</button>
        </div>

        <!-- ã‚¹ãƒ†ãƒƒãƒ—3 -->
        <div class="step-row">
            <span class="step-button">ã‚¹ãƒ†ãƒƒãƒ—3</span>
            <span class="step-text">å•é¡Œã®éŸ³ã‚’è´ã“ã†ã€‚<br>
                â˜… åŸºæº–éŸ³ã® â€ãƒ‰â€ ã‹ã‚‰ä½•éŸ³ä¸ŠãŒã£ã¦ã‚‹ or ä¸‹ãŒã£ã¦ã‚‹ã‹è€ƒãˆã‚‹ã€‚
            </span>
        </div>

        <div class="start-control">
            <button id="start">å•é¡Œã®éŸ³ã‚’è´ã</button>
        </div>

        <!-- ã‚¹ãƒ†ãƒƒãƒ—4 -->
        <div class="step-row">
            <span class="step-button">ã‚¹ãƒ†ãƒƒãƒ—4</span>
            <span class="step-text">
                å•é¡Œã®éŸ³ã‚’ã€é †ç•ªé€šã‚Šã«ä¸‹ã®å›ç­”ãƒœã‚¿ãƒ³ã§å½“ã¦ã‚ˆã†ã€‚<br>
                â˜…ã€ãƒ¬ãƒ™ãƒ«1ã€‘<span class="mid-text">ä¸­éŸ³</span>1éŸ³ã€ãƒ¬ãƒ™ãƒ«2ã€‘<span class="high-text">é«˜éŸ³</span>2éŸ³ã€ãƒ¬ãƒ™ãƒ«3ã€‘<span class="mid-text">ä¸­éŸ³</span>2éŸ³ â†’ <span class="high-text">é«˜éŸ³</span>2éŸ³ã€‚
            </span>
        </div>

        <div class="note-row">
            <h3> - ã€<span class="mid-text"> ä¸­éŸ³ </span>ã€‘å›ç­”ãƒœã‚¿ãƒ³ - </h3>
            <button data-note="do">åŸºæº–éŸ³ "ãƒ‰" ã®ä½ç½®</button>
            <button data-note="re">ãƒ¬</button>
            <button data-note="mi">ãƒŸ</button>
            <button data-note="fa">ãƒ•ã‚¡</button>
            <button data-note="so">ã‚½</button>
            <button data-note="ra">ãƒ©</button>
            <button data-note="si">ã‚·</button>
        </div>

        <div class="note-row">
            <h3> - ã€<span class="high-text"> é«˜éŸ³ </span>ã€‘å›ç­”ãƒœã‚¿ãƒ³ - </h3>
            <button data-note="do2">åŸºæº–éŸ³ "ãƒ‰" ã®ä½ç½®</button>
            <button data-note="re1">ãƒ¬</button>
            <button data-note="mi1">ãƒŸ</button>
            <button data-note="fa1">ãƒ•ã‚¡</button>
            <button data-note="so1">ã‚½</button>
            <button data-note="la1">ãƒ©</button>
            <button data-note="si1">ã‚·</button>
            <button data-note="do1">ãƒ‰</button>
        </div>

        <!-- æ­£è§£ãƒ»ä¸æ­£è§£è¡¨ç¤ºç”¨ -->
        <div id="result-image" style="margin-top:20px;"></div>

        <div class="btn-container">
            {% if user.is_authenticated %}
            <a href="{% url 'mypage' %}"><button type="button">ãƒã‚¤ãƒšãƒ¼ã‚¸ (çµæœ) </button></a>
            {% endif %}
            <button id="showRules" onclick="window.location.href='{% url 'rules' %}'">ãƒ«ãƒ¼ãƒ«ã‚’ç¢ºèªã™ã‚‹</button>
            <form method="post" action="{% url 'logout_view' %}">
                {% csrf_token %}
                <button type="submit">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </form>
        </div>
    </div>

    <!-- JS -->
    <script>
        const midNotes = ["do","re","mi","fa","so","ra","si"];
        const highNotes = ["do2","re1","mi1","fa1","so1","la1","si1","do1"];

        let correctPattern = [];
        let userPattern = [];
        let gameActive = false;

        function getSelectedLevel() {
            const level = document.querySelector('input[name="level"]:checked').value;
            return level;
        }

        function setPattern() {
            const level = getSelectedLevel();
            correctPattern = [];

            if(level === "beginner"){
                // ä¸­éŸ³1éŸ³ãƒ©ãƒ³ãƒ€ãƒ 
                const note = midNotes[Math.floor(Math.random()*midNotes.length)];
                correctPattern.push(note);
            } else if(level === "intermediate"){
                // é«˜éŸ³2éŸ³ãƒ©ãƒ³ãƒ€ãƒ ï¼ˆé‡è¤‡ãªã—ï¼‰
                let copy = [...highNotes];
                for(let i=0;i<2;i++){
                    const idx = Math.floor(Math.random()*copy.length);
                    correctPattern.push(copy[idx]);
                    copy.splice(idx,1);
                }
            } else if(level === "advanced"){
                // ä¸­éŸ³2éŸ³ â†’ é«˜éŸ³2éŸ³
                let midCopy = [...midNotes];
                let highCopy = [...highNotes];
                for(let i=0;i<2;i++){
                    let idx = Math.floor(Math.random()*midCopy.length);
                    correctPattern.push(midCopy[idx]);
                    midCopy.splice(idx,1);
                }
                for(let i=0;i<2;i++){
                    let idx = Math.floor(Math.random()*highCopy.length);
                    correctPattern.push(highCopy[idx]);
                    highCopy.splice(idx,1);
                }
            }
        }

        document.querySelectorAll("button[data-note]").forEach(btn=>{
            btn.addEventListener("click",()=>{
                if(!gameActive) return;
                const note = btn.dataset.note;
                userPattern.push(note);
                playSound(note);
                checkPattern();
            });
        });

        function playSound(note){ 
            new Audio(`/static/sounds/${note}.mp3`).play(); 
        }

        document.getElementById("playMid").addEventListener("click", ()=>{
            playSound("do");
        });
        document.getElementById("playHigh").addEventListener("click", ()=>{
            playSound("do2");
        });

        document.getElementById("start").addEventListener("click",()=>{
            gameActive = true;
            setPattern();
            playPattern();
            userPattern = [];
            document.getElementById("result-image").innerHTML = "";
        });

        function playPattern(){
            let i = 0;
            function playNext(){
                if(i < correctPattern.length){
                    const audio = new Audio(`/static/sounds/${correctPattern[i]}.mp3`);
                    audio.play();
                    audio.onended = ()=>{i++; playNext();}
                }
            }
            playNext();
        }

        // --- CSRF helper: cookie ã‹ã‚‰ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾— (Django æ¨™æº–) ---
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }

        // ã‚µãƒ¼ãƒã«çµæœã‚’é€ã‚‹ï¼ˆ1å•åˆ†ï¼‰
        function sendResult(level, correctArr, userArr){
            const csrftoken = getCookie('csrftoken');
            const payload = {
                level: level,
                correct: correctArr.join(','),     // ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§ä¿å­˜
                user_answer: userArr.join(',')
            };

            fetch('/save_challenge/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken || ''
                },
                body: JSON.stringify(payload),
                credentials: 'same-origin'
            })
            .then(resp => resp.json())
            .then(data => {
                // ãƒ­ã‚°ã‚„ãƒ‡ãƒãƒƒã‚°ç”¨ï¼ˆæœ¬ç•ªã§ã¯çœç•¥å¯ï¼‰
                console.log('save_challenge response', data);
            })
            .catch(err => {
                console.error('save_challenge error', err);
            });
        }

        // é€£ç¶šæ­£è§£ã‚«ã‚¦ãƒ³ã‚¿ï¼ˆsessionStorage ã‚’ä½¿ç”¨ï¼‰
        // key: 'pm_consec_correct'ï¼ˆprefix ã® pm = pitch masterï¼‰
        function getConsecCorrect() {
            const v = sessionStorage.getItem('pm_consec_correct');
            return v ? parseInt(v, 10) : 0;
        }
        function setConsecCorrect(n) {
            sessionStorage.setItem('pm_consec_correct', String(n));
        }

        function checkPattern(){
            const index = userPattern.length-1;
            if(userPattern[index] !== correctPattern[index]){
                // ä¸æ­£è§£
                gameActive = false;
                // ä¸æ­£è§£æ™‚ã¯é€£ç¶šæ­£è§£ã‚«ã‚¦ãƒ³ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ
                setConsecCorrect(0);

                document.getElementById("result-image").innerHTML = '<img src="{% static "images/hu-seikai.PNG" %}" alt="ä¸æ­£è§£" style="max-width:600px;">';

                // ğŸ”Š ä¸æ­£è§£éŸ³ã‚’å†ç”Ÿ
                const wrongSound = new Audio("{% static 'sounds/oshii.mp3' %}");
                wrongSound.play();

                // ã‚µãƒ¼ãƒã¸ä¿å­˜ï¼ˆä¸æ­£è§£ï¼‰
                const level = getSelectedLevel();
                sendResult(level, correctPattern, userPattern);

                return;
            }

            if(userPattern.length === correctPattern.length){
                // æ­£è§£
                gameActive = false;

                // é€£ç¶šæ­£è§£ã‚«ã‚¦ãƒ³ãƒˆã‚’å¢—ã‚„ã™
                let cnt = getConsecCorrect();
                cnt = cnt + 1;
                setConsecCorrect(cnt);

                // é€£ç¶šæ­£è§£ãŒ2å›ä»¥ä¸Šãªã‚‰ mirakuru ã‚’è¡¨ç¤ºã€ãã‚Œä»¥å¤–ã¯é€šå¸¸ã®æ­£è§£ç”»åƒ
                if (cnt >= 2) {
                    document.getElementById("result-image").innerHTML = '<img src="{% static "images/mirakuru.PNG" %}" alt="ãƒŸãƒ©ã‚¯ãƒ«" style="max-width:600px;">';
                } else {
                    document.getElementById("result-image").innerHTML = '<img src="{% static "images/seikai.PNG" %}" alt="æ­£è§£" style="max-width:600px;">';
                }

                // ğŸ”Š æ­£è§£éŸ³ã‚’å†ç”Ÿï¼ˆé€šå¸¸ãƒ»é€£ç¶šæ­£è§£ã©ã¡ã‚‰ã‚‚åŒã˜éŸ³ï¼‰
                const correctSound = new Audio("{% static 'sounds/seikai.mp3' %}");
                correctSound.play();

                // ã‚µãƒ¼ãƒã¸ä¿å­˜ï¼ˆæ­£è§£ï¼‰
                const level = getSelectedLevel();
                sendResult(level, correctPattern, userPattern);
            }
        }
    </script>
</body>
</html>

<!-- éŸ³æºã‚’äº‹å‰ã«èª­ã¿è¾¼ã¿ -->
<audio id="training-audio" src="{% static 'sounds/training_mode.mp3' %}"></audio>
<audio id="stage-audio" src="{% static 'sounds/stage_mode.mp3' %}"></audio>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const params = new URLSearchParams(window.location.search);
    const sound = params.get("sound");

    if (sound === "training") {
        const audio = document.getElementById("training-audio");
        audio.play().catch(err => console.log("éŸ³å£°å†ç”Ÿã‚¨ãƒ©ãƒ¼:", err));
    } else if (sound === "stage") {
        const audio = document.getElementById("stage-audio");
        audio.play().catch(err => console.log("éŸ³å£°å†ç”Ÿã‚¨ãƒ©ãƒ¼:", err));
    }
});
</script>

<script>
window.addEventListener("load", function() {
    const params = new URLSearchParams(window.location.search);
    const play = params.get("play");
    if (play === "training_mode") {
        new Audio("{% static 'sounds/training_mode.mp3' %}").play();
    } else if (play === "stage_mode") {
        new Audio("{% static 'sounds/stage_mode.mp3' %}").play();
    }
});
</script>