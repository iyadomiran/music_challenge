{% load static %}  <!-- Django ã® static ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆCSSã‚„ç”»åƒãªã©ï¼‰ã‚’ä½¿ã†ãŸã‚ã«èª­ã¿è¾¼ã‚€ -->
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Pitch Master</title>

    <!-- Google Fonts ã®èª­ã¿è¾¼ã¿ -->
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Dancing+Script:wght@700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    
    <!-- Django ã® static ãƒ•ã‚©ãƒ«ãƒ€ã‹ã‚‰ CSS ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€ -->
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>
<body class="game">
    <div class="container">
        <h2>ğŸ¹ğŸ¹ğŸ¹ Let's challenge !! ğŸ¹ğŸ¹ğŸ¹</h2>

        <!-- é›£æ˜“åº¦ã‚’é¸ã¶ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ -->
        <div class="difficulty">
            <!-- name="level" ã¯ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã™ã‚‹ãŸã‚ -->
            <!-- checked ã¯åˆæœŸå€¤ã‚’åˆç´šã«ã™ã‚‹ -->
            <label><input type="radio" name="level" value="beginner" checked> åˆç´š</label>
            <label><input type="radio" name="level" value="intermediate"> ä¸­ç´š</label>
            <label><input type="radio" name="level" value="advanced"> ä¸Šç´š</label>
        </div>

        <!-- ã‚²ãƒ¼ãƒ æ“ä½œãƒœã‚¿ãƒ³ -->
        <div class="controls">
            <!-- Django ã® URL ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¿ã‚°ã§ãƒ«ãƒ¼ãƒ«ãƒšãƒ¼ã‚¸ã«é·ç§» -->
            <button id="showRules" onclick="window.location.href='{% url 'rules' %}'">ğŸ“– ãƒ«ãƒ¼ãƒ« ğŸ“–</button>
            <!-- ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ -->
            <button id="start">ğŸ¹ ã‚¹ã‚¿ãƒ¼ãƒˆ ğŸ¹</button>
            <!-- ãƒ’ãƒ³ãƒˆãƒœã‚¿ãƒ³ï¼ˆæ­£è§£ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’èãï¼‰ -->
            <button id="listen">ğŸ§ ãƒ’ãƒ³ãƒˆ ğŸ§</button>
        </div>

        <!-- é«˜éŸ³ã®éµç›¤ -->
        <div class="note-row">
            <h3> - é«˜éŸ³ - </h3>
            <!-- data-note å±æ€§ã«éŸ³åã‚’å…¥ã‚Œã¦ JS ã‹ã‚‰å–å¾—ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ -->
            <button data-note="do2">ãƒ‰</button>
            <button data-note="re1">ãƒ¬</button>
            <button data-note="mi1">ãƒŸ</button>
            <button data-note="fa1">ãƒ•ã‚¡</button>
            <button data-note="so1">ã‚½</button>
            <button data-note="la1">ãƒ©</button>
            <button data-note="si1">ã‚·</button>
            <button data-note="do1">ãƒ‰</button>
        </div>

        <!-- ä¸­éŸ³ã®éµç›¤ -->
        <div class="note-row">
            <h3> - ä¸­éŸ³ - </h3>
            <button data-note="do">ãƒ‰</button>
            <button data-note="re">ãƒ¬</button>
            <button data-note="mi">ãƒŸ</button>
            <button data-note="fa">ãƒ•ã‚¡</button>
            <button data-note="so">ã‚½</button>
            <button data-note="ra">ãƒ©</button>
            <button data-note="si">ã‚·</button>
        </div>

        <!-- å’ŒéŸ³ã®ãƒœã‚¿ãƒ³ -->
        <div class="note-row">
            <h3> - å’ŒéŸ³ - </h3>
            <button data-note="c_low">Cãƒ¡ã‚¸ãƒ£ãƒ¼ (ãƒ‰ãƒ»ãƒŸãƒ»ã‚½)</button>
            <button data-note="g_low">Gãƒ¡ã‚¸ãƒ£ãƒ¼ (ã‚½ãƒ»ã‚·ãƒ»ãƒ¬)</button>
            <button data-note="a_low">Aãƒ¡ã‚¸ãƒ£ãƒ¼ (ãƒ©ãƒ»ãƒ‰#ãƒ»ãƒŸ)</button>
            <button data-note="f_low">Fãƒ¡ã‚¸ãƒ£ãƒ¼ (ãƒ•ã‚¡ãƒ»ãƒ©ãƒ»ãƒ‰)</button>
            <button data-note="am_low">Aãƒã‚¤ãƒŠãƒ¼ (ãƒ©ãƒ»ãƒ‰ãƒ»ãƒŸ)</button>
        </div>

        <!-- ã‚²ãƒ¼ãƒ æƒ…å ±ã®è¡¨ç¤º -->
        <p id="listen-count">ğŸ§ãƒ’ãƒ³ãƒˆğŸ§ å†ç”Ÿå¯èƒ½å›æ•° æ®‹ã‚Š: 5</p>
        <p id="score">ã‚¹ã‚³ã‚¢: 0</p>
        <p id="title"></p>

        <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼é–¢é€£ãƒœã‚¿ãƒ³ -->
        <div class="btn-container">
            {% if user.is_authenticated %}
            <!-- ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ãªã‚‰ãƒã‚¤ãƒšãƒ¼ã‚¸ã¸ã®ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º -->
            <a href="{% url 'mypage' %}"><button type="button">ãƒã‚¤ãƒšãƒ¼ã‚¸</button></a>
            {% endif %}
            <!-- ãƒ­ã‚°ã‚¢ã‚¦ãƒˆç”¨ãƒ•ã‚©ãƒ¼ãƒ  -->
            <form method="post" action="{% url 'logout_view' %}">
                {% csrf_token %}  <!-- CSRF å¯¾ç­–ãƒˆãƒ¼ã‚¯ãƒ³ã‚’åŸ‹ã‚è¾¼ã‚€ -->
                <button type="submit">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </form>
        </div>
    </div>

    <!-- Django ã‹ã‚‰ JS ã«æ­£è§£æ›²ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¸¡ã™ -->
    <script>
        // views.py ã§ context ã«å…¥ã‚ŒãŸ song_patterns ã‚’ JS ã«æ¸¡ã™
        const songPatterns = {{ song_patterns|safe }}; // safe ã‚’ä½¿ã†ã“ã¨ã§ Django ãŒè‡ªå‹•ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã—ãªã„

        // é›£æ˜“åº¦ã”ã¨ã®é…åˆ—ã«åˆ†ã‘ã‚‹
        const beginnerPatterns = songPatterns.beginner || [];
        const intermediatePatterns = songPatterns.intermediate || [];
        const advancedPatterns = songPatterns.advanced || [];

        // ã‚²ãƒ¼ãƒ é€²è¡Œç”¨å¤‰æ•°
        let correctPattern = []; // æ­£è§£ãƒ‘ã‚¿ãƒ¼ãƒ³
        let userPattern = [];    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæŠ¼ã—ãŸéŸ³ã‚’è¨˜éŒ²
        let listenCount = 0;     // ãƒ’ãƒ³ãƒˆã‚’èã„ãŸå›æ•°
        const maxListen = 5;     // ãƒ’ãƒ³ãƒˆã®æœ€å¤§å›æ•°
        let attempts = 0;        // è©¦è¡Œå›æ•°
        let gameActive = false;  // ã‚²ãƒ¼ãƒ ãŒé–‹å§‹ã•ã‚Œã¦ã„ã‚‹ã‹ã®ãƒ•ãƒ©ã‚°

        // é¸æŠã•ã‚ŒãŸé›£æ˜“åº¦ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¿”ã™é–¢æ•°
        function getSelectedLevel() {
            const level = document.querySelector('input[name="level"]:checked').value;
            if(level==="beginner") return beginnerPatterns;
            if(level==="intermediate") return intermediatePatterns;
            if(level==="advanced") return advancedPatterns;
        }

        // æ­£è§£ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«é¸ã¶
        function setPattern() {
            const patterns = getSelectedLevel(); // é›£æ˜“åº¦ã”ã¨ã®é…åˆ—ã‚’å–å¾—
            correctPattern = patterns[Math.floor(Math.random()*patterns.length)];
        }

        // éµç›¤ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã¨ãã®å‡¦ç†
        document.querySelectorAll("button[data-note]").forEach(btn=>{
            btn.addEventListener("click",()=>{
                if(!gameActive) return; // ã‚²ãƒ¼ãƒ é–‹å§‹å‰ã¯æŠ¼ã—ã¦ã‚‚ç„¡åŠ¹
                const note = btn.dataset.note; // æŠ¼ã—ãŸãƒœã‚¿ãƒ³ã®éŸ³ã‚’å–å¾—
                userPattern.push(note);       // é…åˆ—ã«è¿½åŠ 
                playSound(note);              // éŸ³ã‚’å†ç”Ÿ
                checkPattern();               // æ­£è§£ã¨æ¯”è¼ƒ
            });
        });

        // éŸ³ã‚’å†ç”Ÿã™ã‚‹é–¢æ•°
        function playSound(note){ 
            new Audio(`/static/sounds/${note}.mp3`).play(); 
        }

        // ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚
        document.getElementById("start").addEventListener("click",()=>{
            gameActive = true; // ã‚²ãƒ¼ãƒ é–‹å§‹
            setPattern();      // æ­£è§£ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ã‚»ãƒƒãƒˆ
            playPattern();     // æ­£è§£ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å†ç”Ÿ
            listenCount = 1;   // åˆå›å†ç”Ÿã¨ã—ã¦ã‚«ã‚¦ãƒ³ãƒˆ
            attempts = 0;      // è©¦è¡Œå›æ•°ãƒªã‚»ãƒƒãƒˆ
            userPattern = [];  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›ãƒªã‚»ãƒƒãƒˆ
            // HTMLã«æ®‹ã‚Šå›æ•°ã‚„ã‚¹ã‚³ã‚¢ã‚’åæ˜ 
            document.getElementById("listen-count").innerText = "ğŸ§ãƒ’ãƒ³ãƒˆğŸ§ æ®‹ã‚Š: " + (maxListen-listenCount);
            document.getElementById("score").innerText = "ã‚¹ã‚³ã‚¢: 0";
            document.getElementById("title").innerText = "";
            document.getElementById("title").style.display = "none";
        });

        // ãƒ’ãƒ³ãƒˆãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚
        document.getElementById("listen").addEventListener("click",()=>{
            if(!gameActive) return;           // ã‚²ãƒ¼ãƒ ä¸­ã§ãªã‘ã‚Œã°ç„¡åŠ¹
            if(listenCount >= maxListen){     // ãƒ’ãƒ³ãƒˆå›æ•°ã®ä¸Šé™ãƒã‚§ãƒƒã‚¯
                alert("ã‚‚ã†èã‘ã¾ã›ã‚“ï¼ğŸ’¦");
                return;
            }
            playPattern(); // æ­£è§£ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å†ç”Ÿ
            listenCount++; // ãƒ’ãƒ³ãƒˆå›æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
            document.getElementById("listen-count").innerText = "ğŸ§ãƒ’ãƒ³ãƒˆğŸ§ æ®‹ã‚Š: " + (maxListen-listenCount);
        });

        // æ­£è§£ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’é †ç•ªã«å†ç”Ÿã™ã‚‹é–¢æ•°
        function playPattern(){
            const base = new Audio("/static/sounds/do.mp3"); // æœ€åˆã®éŸ³ã‚’å†ç”Ÿï¼ˆä¾‹ã¨ã—ã¦ doï¼‰
            base.play();
            base.onended = () => {
                // 2ç§’å¾…ã£ã¦ã‹ã‚‰æ­£è§£ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’é †ç•ªã«å†ç”Ÿ
                setTimeout(()=>{
                    let i = 0; // é…åˆ—ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
                    function playNext(){
                        if(i < correctPattern.length){ // ã¾ã å†ç”Ÿã™ã‚‹éŸ³ãŒæ®‹ã£ã¦ã„ã‚‹ã‹
                            const audio = new Audio(`/static/sounds/${correctPattern[i]}.mp3`);
                            audio.play();
                            // éŸ³ãŒçµ‚ã‚ã£ãŸã‚‰æ¬¡ã®éŸ³ã‚’å†ç”Ÿ
                            audio.onended = () => { 
                                i++; 
                                playNext(); 
                            };
                        }
                    }
                    playNext(); // å†ç”Ÿé–‹å§‹
                }, 2000);
            };
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæŠ¼ã—ãŸéŸ³ã‚’æ­£è§£ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨æ¯”è¼ƒã™ã‚‹é–¢æ•°
        function checkPattern(){
            const index = userPattern.length-1; // æœ€æ–°ã®å…¥åŠ›ã®ä½ç½®
            if(userPattern[index] === correctPattern[index]){ // æ­£ã—ã„ã‹
                if(userPattern.length === correctPattern.length){ // å…¨éƒ¨æ­£è§£ã—ãŸå ´åˆ
                    attempts++; // è©¦è¡Œå›æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
                    const score = (maxListen - listenCount + 1) * 20; // ã‚¹ã‚³ã‚¢è¨ˆç®—
                    let title = "";
                    // ã‚¹ã‚³ã‚¢ã«å¿œã˜ãŸç§°å·ã‚’è¨­å®š
                    if(score === 100) title = "ğŸ‘‘ ç‹è€… !! ã‚ãªãŸã¯éŸ³æ¥½ã®ç¥ï¼";
                    else if(score >= 80) title = "ğŸŒŸ åäºº !! ãƒ¡ãƒ­ãƒ‡ã‚£ã‚’æ¥µã‚ãŸè€…ï¼";
                    else if(score >= 60) title = "ğŸ… ä¸Šç´šè€… !! ã‚ˆãã§ãã¾ã—ãŸï¼";
                    else if(score >= 40) title = "ğŸ–ï¸ åˆç´šè€… !! ã‚ã¨å°‘ã—ï¼";
                    else title = "ğŸ… ãƒ“ã‚®ãƒŠãƒ¼ !! æŒ‘æˆ¦ã™ã‚‹å¿ƒãŒå¤§äº‹ï¼";

                    alert(`ã‚¯ãƒªã‚¢ï¼ã‚¹ã‚³ã‚¢: ${score} ç‚¹`);
                    document.getElementById("score").innerText = "ã‚¹ã‚³ã‚¢: " + score;
                    document.getElementById("title").innerText = title;
                    document.getElementById("title").style.display = "inline-block";
                    gameActive = false; // ã‚²ãƒ¼ãƒ çµ‚äº†

                    {% if user.is_authenticated %}
                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¤ãƒ³ä¸­ãªã‚‰ã‚¹ã‚³ã‚¢ã‚’ä¿å­˜ã™ã‚‹
                    fetch("{% url 'save_score' %}", {
                        method: "POST",
                        headers: {'X-CSRFToken': '{{ csrf_token }}'}, // CSRFãƒˆãƒ¼ã‚¯ãƒ³
                        body: new URLSearchParams({'score': score}) // ãƒ•ã‚©ãƒ¼ãƒ å½¢å¼ã§é€ä¿¡
                    })
                    .then(response => {
                        if(response.ok) alert("ã‚¹ã‚³ã‚¢ãŒä¿å­˜ã•ã‚Œã¾ã—ãŸï¼");
                        else alert("ã‚¹ã‚³ã‚¢ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
                    })
                    .catch(err => { console.error(err); alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼"); });
                    {% endif %}
                }
            } else {
                // é–“é•ãˆãŸå ´åˆ
                attempts++;
                if(attempts >= maxListen){ // æœ€å¤§è©¦è¡Œå›æ•°ã«é”ã—ãŸã‚‰ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼
                    alert("ãƒãƒ£ãƒ¬ãƒ³ã‚¸å¤±æ•—ï¼ğŸ’¦ æ®‹å¿µï¼");
                    // ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
                    userPattern = [];
                    listenCount = 0;
                    attempts = 0;
                    document.getElementById("listen-count").innerText = "ğŸ§ãƒ’ãƒ³ãƒˆğŸ§ æ®‹ã‚Š: " + maxListen;
                    document.getElementById("title").innerText = "";
                    document.getElementById("title").style.display = "none";
                    document.getElementById("score").innerText = "0";
                    gameActive = false;
                } else {
                    // é–“é•ãˆãŸãŒã¾ã è©¦è¡Œå¯èƒ½ãªå ´åˆ
                    alert("é•ã†ã‚ˆï¼ğŸ˜ ã‚‚ã†ä¸€å›æœ€åˆã‹ã‚‰æŠ¼ãã†ï¼");
                    userPattern = []; // å…¥åŠ›ã‚’ãƒªã‚»ãƒƒãƒˆ
                }
            }
        }
    </script>
</body>
</html>