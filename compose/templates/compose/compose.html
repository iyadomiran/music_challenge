{% load static %}
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Pitch Master</title>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Dancing+Script:wght@700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>
<body class="game">
    <div class="container">
        <h2>ğŸ¹ğŸ¹ğŸ¹ Let's challenge !! ğŸ¹ğŸ¹ğŸ¹</h2>

        <!-- é›£æ˜“åº¦é¸æŠ -->
        <div class="difficulty">
            <label><input type="radio" name="level" value="beginner" checked> åˆç´š</label>
            <label><input type="radio" name="level" value="intermediate"> ä¸­ç´š</label>
            <label><input type="radio" name="level" value="advanced"> ä¸Šç´š</label>
        </div>

        <!-- ã‚¹ã‚¿ãƒ¼ãƒˆ & ãƒ’ãƒ³ãƒˆ & ãƒ«ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ -->
        <div class="controls">
            <button id="showRules" onclick="window.location.href='{% url 'rules' %}'">ğŸ“– ãƒ«ãƒ¼ãƒ« ğŸ“–</button>
            <button id="start">ğŸ¹ ã‚¹ã‚¿ãƒ¼ãƒˆ ğŸ¹</button>
            <button id="listen">ğŸ§ ãƒ’ãƒ³ãƒˆ ğŸ§</button>
        </div>

        <!-- é«˜éŸ³ -->
        <div class="note-row">
            <h3> - é«˜éŸ³ - </h3>
            <button data-note="do2">C6</button>
            <button data-note="re1">D5</button>
            <button data-note="mi1">E5</button>
            <button data-note="fa1">F5</button>
            <button data-note="so1">G5</button>
            <button data-note="la1">A5</button>
            <button data-note="si1">B5</button>
            <button data-note="do1">C5</button>
        </div>

        <!-- ä¸­éŸ³ -->
        <div class="note-row">
            <h3> - ä¸­éŸ³ - </h3>
            <button data-note="do">C4</button>
            <button data-note="re">D4</button>
            <button data-note="mi">E4</button>
            <button data-note="fa">F4</button>
            <button data-note="so">G4</button>
            <button data-note="ra">A4</button>
            <button data-note="si">B4</button>
        </div>

        <!-- å’ŒéŸ³ -->
        <div class="note-row">
            <h3> - å’ŒéŸ³ - </h3>
            <button data-note="g_low">G Major</button>
            <button data-note="c_low">C Major</button>
            <button data-note="a_low">A Major</button>
            <button data-note="f_low">F Major</button>
            <button data-note="am_low">A Minor</button>
        </div>

        <p id="listen-count">ğŸ§ãƒ’ãƒ³ãƒˆğŸ§ å†ç”Ÿå¯èƒ½å›æ•° æ®‹ã‚Š: 5</p>
        <p id="score">ã‚¹ã‚³ã‚¢: 0</p>
        <p id="title"></p>

        <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã®ãƒœã‚¿ãƒ³ -->
        <div class="btn-container">
            {% if user.is_authenticated %}
            <a href="{% url 'mypage' %}"><button type="button">ãƒã‚¤ãƒšãƒ¼ã‚¸</button></a>
            {% endif %}
            
            <!-- ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã¯å¸¸ã«è¡¨ç¤º -->
            <form method="post" action="{% url 'logout_view' %}">
                {% csrf_token %}
                <button type="submit">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </form>
        </div>
    </div>

    <script>
        const beginnerPatterns = [["do1","do","g_low"],["re1","re","c_low"],["mi1","mi","a_low"]];
        const intermediatePatterns = [["do1","re1","do","re","g_low","c_low"],["mi1","fa1","mi","fa","a_low","f_low"],["so1","la1","so","la","g_low","a_low"]];
        const advancedPatterns = [["do1","re1","mi1","do","re","mi","g_low","c_low","a_low"],["fa1","so1","la1","fa","so","la","f_low","a_low","g_low"],["mi1","fa1","so1","mi","fa","so","c_low","g_low","am_low"]];

        let correctPattern = [];
        let userPattern = [];
        let listenCount = 0;
        const maxListen = 5;
        let attempts = 0;
        let gameActive = false;

        function getSelectedLevel() {
            const level = document.querySelector('input[name="level"]:checked').value;
            if(level==="beginner") return beginnerPatterns;
            if(level==="intermediate") return intermediatePatterns;
            if(level==="advanced") return advancedPatterns;
        }

        function setPattern() {
            const patterns = getSelectedLevel();
            correctPattern = patterns[Math.floor(Math.random()*patterns.length)];
        }

        document.querySelectorAll("button[data-note]").forEach(btn=>{
            btn.addEventListener("click",()=>{
                if(!gameActive) return;
                const note = btn.dataset.note;
                userPattern.push(note);
                playSound(note);
                checkPattern();
            });
        });

        function playSound(note){ new Audio(`/static/sounds/${note}.mp3`).play(); }

        document.getElementById("start").addEventListener("click",()=>{
            gameActive = true;
            setPattern();
            playPattern();
            listenCount = 1;
            attempts = 0;
            userPattern = [];
            document.getElementById("listen-count").innerText = "ğŸ§ãƒ’ãƒ³ãƒˆğŸ§ å†ç”Ÿå¯èƒ½å›æ•° æ®‹ã‚Š: " + (maxListen-listenCount);
            document.getElementById("score").innerText = "ã‚¹ã‚³ã‚¢: 0";
            document.getElementById("title").innerText = "";
            document.getElementById("title").style.display = "none";
        });

        document.getElementById("listen").addEventListener("click",()=>{
            if(!gameActive) return;
            if(listenCount >= maxListen){ alert("ã‚‚ã†èã‘ã¾ã›ã‚“ï¼ğŸ’¦"); return; }
            playPattern();
            listenCount++;
            document.getElementById("listen-count").innerText = "ğŸ§ãƒ’ãƒ³ãƒˆğŸ§ å†ç”Ÿå¯èƒ½å›æ•° æ®‹ã‚Š: " + (maxListen-listenCount);
        });

        function playPattern(){
            let i = 0;
            const interval = setInterval(()=>{
                playSound(correctPattern[i]);
                i++;
                if(i >= correctPattern.length) clearInterval(interval);
            }, 600);
        }

        function checkPattern(){
            const index = userPattern.length-1;
            if(userPattern[index] === correctPattern[index]){
                if(userPattern.length === correctPattern.length){
                    attempts++;
                    const score = (maxListen - listenCount + 1) * 20;
                    let title = "";
                    if(score === 100) title = "ğŸ—£ï¸ ç§°å·ï¼šğŸ‘‘ ç‹è€… !! ğŸ‘‘ ã‚ãªãŸã¯éŸ³æ¥½ã®ç¥ï¼";
                    else if(score >= 80) title = "ğŸ—£ï¸ ç§°å·ï¼šğŸŒŸ åäºº !! ğŸŒŸ ãƒ¡ãƒ­ãƒ‡ã‚£ã‚’æ¥µã‚ãŸè€…ï¼";
                    else if(score >= 60) title = "ğŸ—£ï¸ ç§°å·ï¼šğŸ… ä¸Šç´šè€… !! ğŸ… ã‚ˆãã§ãã¾ã—ãŸï¼";
                    else if(score >= 40) title = "ğŸ—£ï¸ ç§°å·ï¼šğŸ–ï¸ åˆç´šè€… !! ğŸ–ï¸ ã‚ã¨å°‘ã—ã§ä¸Šé”ï¼";
                    else title = "ğŸ—£ï¸ ç§°å·ï¼šğŸ… ãƒ“ã‚®ãƒŠãƒ¼ !! ğŸ… æŒ‘æˆ¦ã™ã‚‹å¿ƒãŒå¤§äº‹ï¼";

                    alert(`ã‚¯ãƒªã‚¢ï¼ã‚¹ã‚³ã‚¢: ${score} ç‚¹`);
                    document.getElementById("score").innerText = "ã‚¹ã‚³ã‚¢: " + score;
                    document.getElementById("title").innerText = title;
                    document.getElementById("title").style.display = "inline-block";
                    gameActive = false;

                    // ç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ã‚¹ã‚³ã‚¢ä¿å­˜
                    {% if user.is_authenticated %}
                    fetch("{% url 'save_score' %}", {
                        method: "POST",
                        headers: {'X-CSRFToken': '{{ csrf_token }}'},
                        body: new URLSearchParams({'score': score})
                    })
                    .then(response => {
                        if(response.ok) alert("ã‚¹ã‚³ã‚¢ãŒä¿å­˜ã•ã‚Œã¾ã—ãŸï¼");
                        else alert("ã‚¹ã‚³ã‚¢ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
                    })
                    .catch(err => { console.error(err); alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼"); });
                    {% endif %}
                }
            } else {
                attempts++;
                if(attempts >= maxListen){
                    alert("ãƒãƒ£ãƒ¬ãƒ³ã‚¸å¤±æ•—ï¼ğŸ’¦ğŸ’¦ æ®‹å¿µï¼");
                    userPattern = [];
                    listenCount = 0;
                    attempts = 0;
                    document.getElementById("listen-count").innerText = "ğŸ§ãƒ’ãƒ³ãƒˆğŸ§ å†ç”Ÿå¯èƒ½å›æ•° æ®‹ã‚Š: " + maxListen;
                    document.getElementById("title").innerText = "";
                    document.getElementById("title").style.display = "none";
                    document.getElementById("score").innerText = "0";
                    gameActive = false;
                } else {
                    alert("é•ã†ã‚ˆï¼ğŸ˜ ã‚‚ã†ä¸€å›æœ€åˆã‹ã‚‰æŠ¼ãã†ï¼");
                    userPattern = [];
                }
            }
        }
    </script>
</body>
</html>