{% load static %}
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <title>Pitch Master - ãƒã‚¤ãƒšãƒ¼ã‚¸</title>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <!-- å¤–éƒ¨CSS -->
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link rel="stylesheet" href="{% static 'css/steps.css' %}">
    <!-- ç§»å‹•ã—ãŸã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ« -->
    <link rel="stylesheet" href="{% static 'css/mypage_custom.css' %}">
</head>
<body class="mypage">
<div class="top-container mypage">
    {% if user.is_authenticated %}
        <h2>ä»Šæ—¥ã®{{ user.username }}ã•ã‚“ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°çµæœ</h2>

        <div class="section">
            <h3>ä»Šæ—¥ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°çµæœã‚’æŒ¯ã‚Šè¿”ã‚ã†ï¼</h3>
            <div class="challenge-log">
                {% for c in challenges %}
                    <p>
                        {{ forloop.counter }}å•ç›®(
                        ãƒ¬ãƒ™ãƒ«
                        {% if c.level == 'beginner' %}
                            1
                        {% elif c.level == 'intermediate' %}
                            2
                        {% elif c.level == 'advanced' %}
                            3
                        {% else %}
                            {{ c.level }}
                        {% endif %}
                        é¸æŠ) â–¶ï¸ æ­£è§£éŸ³:
                        {% if c.correct == 'do' or c.correct == 'ãƒ‰' %}
                            ãƒ‰
                        {% elif c.correct == 're' or c.correct == 'ãƒ¬' %}
                            ãƒ¬
                        {% elif c.correct == 'mi' or c.correct == 'ãƒŸ' %}
                            ãƒŸ
                        {% elif c.correct == 'fa' or c.correct == 'ãƒ•ã‚¡' %}
                            ãƒ•ã‚¡
                        {% elif c.correct == 'so' or c.correct == 'ã‚½' %}
                            ã‚½
                        {% elif c.correct == 'ra' or c.correct == 'la' or c.correct == 'ãƒ©' %}
                            ãƒ©
                        {% elif c.correct == 'si' or c.correct == 'ã‚·' %}
                            ã‚·
                        {% elif c.correct == 'do1' or c.correct == 'é«˜ãƒ‰' or c.correct == 'é«˜ãƒ‰1' %}
                            ãƒ‰ï¼ˆé«˜ï¼‰
                        {% elif c.correct == 're1' or c.correct == 'é«˜ãƒ¬' %}
                            ãƒ¬ï¼ˆé«˜ï¼‰
                        {% elif c.correct == 'mi1' or c.correct == 'é«˜ãƒŸ' %}
                            ãƒŸï¼ˆé«˜ï¼‰
                        {% elif c.correct == 'fa1' or c.correct == 'é«˜ãƒ•ã‚¡' %}
                            ãƒ•ã‚¡ï¼ˆé«˜ï¼‰
                        {% elif c.correct == 'so1' or c.correct == 'é«˜ã‚½' %}
                            ã‚½ï¼ˆé«˜ï¼‰
                        {% elif c.correct == 'la1' or c.correct == 'é«˜ãƒ©' %}
                            ãƒ©ï¼ˆé«˜ï¼‰
                        {% elif c.correct == 'si1' or c.correct == 'é«˜ã‚·' %}
                            ã‚·ï¼ˆé«˜ï¼‰
                        {% elif c.correct == 'do2' or c.correct == 'ã•ã‚‰ã«é«˜éŸ³ãƒ‰' or c.correct == 'high_do2' %}
                            ãƒ‰ï¼ˆæœ€é«˜ï¼‰
                        {% else %}
                            {{ c.correct }}
                        {% endif %}
                        ã€€å›ç­”éŸ³:
                        {% if c.user_answer == 'do' or c.user_answer == 'ãƒ‰' %}
                            ãƒ‰
                        {% elif c.user_answer == 're' or c.user_answer == 'ãƒ¬' %}
                            ãƒ¬
                        {% elif c.user_answer == 'mi' or c.user_answer == 'ãƒŸ' %}
                            ãƒŸ
                        {% elif c.user_answer == 'fa' or c.user_answer == 'ãƒ•ã‚¡' %}
                            ãƒ•ã‚¡
                        {% elif c.user_answer == 'so' or c.user_answer == 'ã‚½' %}
                            ã‚½
                        {% elif c.user_answer == 'ra' or c.user_answer == 'la' or c.user_answer == 'ãƒ©' %}
                            ãƒ©
                        {% elif c.user_answer == 'si' or c.user_answer == 'ã‚·' %}
                            ã‚·
                        {% elif c.user_answer == 'do1' or c.user_answer == 'é«˜ãƒ‰' or c.user_answer == 'é«˜ãƒ‰1' %}
                            ãƒ‰ï¼ˆé«˜ï¼‰
                        {% elif c.user_answer == 're1' or c.user_answer == 'é«˜ãƒ¬' %}
                            ãƒ¬ï¼ˆé«˜ï¼‰
                        {% elif c.user_answer == 'mi1' or c.user_answer == 'é«˜ãƒŸ' %}
                            ãƒŸï¼ˆé«˜ï¼‰
                        {% elif c.user_answer == 'fa1' or c.user_answer == 'é«˜ãƒ•ã‚¡' %}
                            ãƒ•ã‚¡ï¼ˆé«˜ï¼‰
                        {% elif c.user_answer == 'so1' or c.user_answer == 'é«˜ã‚½' %}
                            ã‚½ï¼ˆé«˜ï¼‰
                        {% elif c.user_answer == 'la1' or c.user_answer == 'é«˜ãƒ©' %}
                            ãƒ©ï¼ˆé«˜ï¼‰
                        {% elif c.user_answer == 'si1' or c.user_answer == 'é«˜ã‚·' %}
                            ã‚·ï¼ˆé«˜ï¼‰
                        {% elif c.user_answer == 'do2' or c.user_answer == 'ã•ã‚‰ã«é«˜éŸ³ãƒ‰' or c.user_answer == 'high_do2' %}
                            ãƒ‰ï¼ˆæœ€é«˜ï¼‰
                        {% else %}
                            {{ c.user_answer }}
                        {% endif %}
                        ã€€ã§{% if c.correct == c.user_answer %}æ­£è§£ï¼â­•ï¸{% else %}é–“é•ã„ï¼âŒ{% endif %}
                    </p>
                {% empty %}
                    <p>ä»Šæ—¥ã®ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                {% endfor %}
            </div>

            <div class="summary">
                â­ï¸ä»Šæ—¥ã¯ã€ã€{{ challenges|length|default:0 }}å•ã€‘ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã—ã¾ã—ãŸï¼ï¼<br>
                â­ï¸{{ correct_count|default:0 }}å•æ­£è§£ã®ãŸã‚ã€æ­£è§£ç‡ã€{{ correct_rate|default:0 }}%ã€‘ã§ã™ã€‚<br>

                <div style="margin-top:8px;">
                    {% with wrong_count=0 %}
                        {% for c in challenges %}
                            {% if c.correct != c.user_answer %}
                                {% if c.correct == 'do' or c.correct == 'ãƒ‰' %}
                                    <p>ğŸ’§è‹¦æ‰‹éŸ³ç¨‹ï¼šå®Œå…¨1åº¦ï¼ˆåŒéŸ³ï¼‰ï¼ä¸­éŸ³åŸŸ</p>
                                {% elif c.correct == 're' or c.correct == 'ãƒ¬' %}
                                    <p>ğŸ’§è‹¦æ‰‹éŸ³ç¨‹ï¼šé•·2åº¦ä¸Šï¼ˆãƒ‰â†’ãƒ¬ï¼‰ï¼ä¸­éŸ³åŸŸ</p>
                                {% elif c.correct == 'mi' or c.correct == 'ãƒŸ' %}
                                    <p>ğŸ’§è‹¦æ‰‹éŸ³ç¨‹ï¼šé•·3åº¦ä¸Šï¼ˆãƒ‰â†’ãƒŸï¼‰ï¼ä¸­éŸ³åŸŸ</p>
                                {% elif c.correct == 'fa' or c.correct == 'ãƒ•ã‚¡' %}
                                    <p>ğŸ’§è‹¦æ‰‹éŸ³ç¨‹ï¼šå®Œå…¨4åº¦ä¸Šï¼ˆãƒ‰â†’ãƒ•ã‚¡ï¼‰ï¼ä¸­éŸ³åŸŸ</p>
                                {% elif c.correct == 'so' or c.correct == 'ã‚½' %}
                                    <p>ğŸ’§è‹¦æ‰‹éŸ³ç¨‹ï¼šå®Œå…¨5åº¦ä¸Šï¼ˆãƒ‰â†’ã‚½ï¼‰ï¼ä¸­éŸ³åŸŸ</p>
                                {% elif c.correct == 'ra' or c.correct == 'la' or c.correct == 'ãƒ©' %}
                                    <p>ğŸ’§è‹¦æ‰‹éŸ³ç¨‹ï¼šé•·6åº¦ä¸Šï¼ˆãƒ‰â†’ãƒ©ï¼‰ï¼ä¸­éŸ³åŸŸ</p>
                                {% elif c.correct == 'si' or c.correct == 'ã‚·' %}
                                    <p>ğŸ’§è‹¦æ‰‹éŸ³ç¨‹ï¼šé•·7åº¦ä¸Šï¼ˆãƒ‰â†’ã‚·ï¼‰ï¼ä¸­éŸ³åŸŸ</p>
                                {% elif c.correct == 'do1' or c.correct == 'é«˜ãƒ‰' or c.correct == 'é«˜ãƒ‰1' %}
                                    <p>ğŸ’§è‹¦æ‰‹éŸ³ç¨‹ï¼šå®Œå…¨1åº¦ï¼ˆåŒéŸ³ï¼‰ï¼é«˜éŸ³åŸŸ</p>
                                {% elif c.correct == 're1' or c.correct == 'é«˜ãƒ¬' %}
                                    <p>ğŸ’§è‹¦æ‰‹éŸ³ç¨‹ï¼šé•·2åº¦ä¸Šï¼ˆé«˜éŸ³ãƒ‰â†’é«˜éŸ³ãƒ¬ï¼‰ï¼é«˜éŸ³åŸŸ</p>
                                {% elif c.correct == 'mi1' or c.correct == 'é«˜ãƒŸ' %}
                                    <p>ğŸ’§è‹¦æ‰‹éŸ³ç¨‹ï¼šé•·3åº¦ä¸Šï¼ˆé«˜éŸ³ãƒ‰â†’é«˜éŸ³ãƒŸï¼‰ï¼é«˜éŸ³åŸŸ</p>
                                {% elif c.correct == 'fa1' or c.correct == 'é«˜ãƒ•ã‚¡' %}
                                    <p>ğŸ’§è‹¦æ‰‹éŸ³ç¨‹ï¼šå®Œå…¨4åº¦ä¸Šï¼ˆé«˜éŸ³ãƒ‰â†’é«˜éŸ³ãƒ•ã‚¡ï¼‰ï¼é«˜éŸ³åŸŸ</p>
                                {% elif c.correct == 'so1' or c.correct == 'é«˜ã‚½' %}
                                    <p>ğŸ’§è‹¦æ‰‹éŸ³ç¨‹ï¼šå®Œå…¨5åº¦ä¸Šï¼ˆé«˜éŸ³ãƒ‰â†’é«˜éŸ³ã‚½ï¼‰ï¼é«˜éŸ³åŸŸ</p>
                                {% elif c.correct == 'la1' or c.correct == 'é«˜ãƒ©' %}
                                    <p>ğŸ’§è‹¦æ‰‹éŸ³ç¨‹ï¼šé•·6åº¦ä¸Šï¼ˆé«˜éŸ³ãƒ‰â†’é«˜éŸ³ãƒ©ï¼‰ï¼é«˜éŸ³åŸŸ</p>
                                {% elif c.correct == 'si1' or c.correct == 'é«˜ã‚·' %}
                                    <p>ğŸ’§è‹¦æ‰‹éŸ³ç¨‹ï¼šé•·7åº¦ä¸Šï¼ˆé«˜éŸ³ãƒ‰â†’é«˜éŸ³ã‚·ï¼‰ï¼é«˜éŸ³åŸŸ</p>
                                {% elif c.correct == 'do2' or c.correct == 'ã•ã‚‰ã«é«˜éŸ³ãƒ‰' or c.correct == 'high_do2' %}
                                    <p>ğŸ’§è‹¦æ‰‹éŸ³ç¨‹ï¼šå®Œå…¨8åº¦ä¸Šï¼ˆé«˜éŸ³ãƒ‰â†’ã•ã‚‰ã«é«˜éŸ³ãƒ‰ï¼‰ï¼é«˜éŸ³åŸŸä¸Šé™</p>
                                {% else %}
                                    <p>ğŸ’§è‹¦æ‰‹éŸ³ç¨‹ï¼š{{ c.correct }}ï¼ˆåˆ¤å®šã‚­ãƒ¼ï¼‰ï¼èª¤ç­”è¨˜éŒ²ã‚ã‚Š</p>
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                    {% endwith %}

                    {% if not challenges %}
                    ğŸ’§è‹¦æ‰‹ãªéŸ³ã¯ã€{{ weak_notes|default:''|join:'ã€' }}ã€‘ã§ã™ã€‚
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- éå»ã®çµæœ -->
        <div class="section">
            <h3>éå»ã®çµæœã‚’è¦‹ã‚ˆã†ï¼ˆä»Šé€±ï¼šæœˆã€œæ—¥ï¼‰</h3>
            <div class="week-accordion" id="weekAccordion">
                {% for day in past_week_grouped %}
                    <div class="day-block">
                        <div class="day-header" data-day-index="{{ forloop.counter0 }}">
                            <div class="day-title">{{ day.date|date:"Yå¹´næœˆjæ—¥ï¼ˆDï¼‰" }}</div>
                            <div class="day-count">{{ day.items|length }}å•ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã—ãŸã‚ˆ</div>
                        </div>
                        <div class="day-body" id="day-body-{{ forloop.counter0 }}">
                            {% if day.items %}
                                {% for item in day.items %}
                                    <div class="week-item">
                                        <strong>{{ item.created_at|date:"H:i" }}</strong> â€”
                                        ãƒ¬ãƒ™ãƒ«:
                                        {% if item.level == 'beginner' %}1{% elif item.level == 'intermediate' %}2{% elif item.level == 'advanced' %}3{% else %}{{ item.level }}{% endif %}
                                        ï¼ æ­£è§£:
                                        {% if item.correct == 'do' or item.correct == 'ãƒ‰' %}ãƒ‰{% elif item.correct == 're' or item.correct == 'ãƒ¬' %}ãƒ¬{% elif item.correct == 'mi' or item.correct == 'ãƒŸ' %}ãƒŸ{% elif item.correct == 'fa' or item.correct == 'ãƒ•ã‚¡' %}ãƒ•ã‚¡{% elif item.correct == 'so' or item.correct == 'ã‚½' %}ã‚½{% elif item.correct == 'ra' or item.correct == 'la' or item.correct == 'ãƒ©' %}ãƒ©{% elif item.correct == 'si' or item.correct == 'ã‚·' %}ã‚·{% else %}{{ item.correct }}{% endif %}
                                        ï¼ å›ç­”:
                                        {% if item.user_answer == 'do' or item.user_answer == 'ãƒ‰' %}ãƒ‰{% elif item.user_answer == 're' or item.user_answer == 'ãƒ¬' %}ãƒ¬{% elif item.user_answer == 'mi' or item.user_answer == 'ãƒŸ' %}ãƒŸ{% elif item.user_answer == 'fa' or item.user_answer == 'ãƒ•ã‚¡' %}ãƒ•ã‚¡{% elif item.user_answer == 'so' or item.user_answer == 'ã‚½' %}ã‚½{% elif item.user_answer == 'ra' or item.user_answer == 'la' or item.user_answer == 'ãƒ©' %}ãƒ©{% elif item.user_answer == 'si' or item.user_answer == 'ã‚·' %}ã‚·{% else %}{{ item.user_answer }}{% endif %}
                                        ï¼ {% if item.correct == item.user_answer %}æ­£è§£âœ…{% else %}é–“é•ã„âŒ{% endif %}
                                    </div>
                                {% endfor %}
                            {% else %}
                                <div class="no-items">ã“ã®æ—¥ã¯è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            </div>
            <p style="font-size:0.8rem; margin-top:8px;">â€»æ—¥ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ãã®æ—¥ã®è¨˜éŒ²ã‚’é–‹é–‰ã§ãã¾ã™ï¼ˆ0ä»¶ã®æ—¥ã‚‚è¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰ã€‚</p>

            <!-- Googleãƒ•ã‚©ãƒ¼ãƒ æå‡º -->
            <div class="teacher-form-simple" id="teacherFormSimple">
                <h3>ä¸€é€±é–“åˆ†ã®çµæœã‚’å…ˆç”Ÿã«æå‡ºã—ã‚ˆã†ï¼ˆGoogleãƒ•ã‚©ãƒ¼ãƒ ï¼‰</h3>
                <input type="text" id="teacherFormUrl" placeholder="å…ˆç”Ÿã‹ã‚‰é…å¸ƒã•ã‚ŒãŸGoogleãƒ•ã‚©ãƒ¼ãƒ ã®URLã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ï¼ˆä¾‹: https://docs.google.com/forms/...ï¼‰">
                <label>
                    <input type="checkbox" id="consentCheckbox">
                    URLã«é–“é•ã„ã¯ã‚ã‚Šã¾ã›ã‚“ï¼ˆå…ˆç”Ÿã‹ã‚‰é…å¸ƒã•ã‚ŒãŸæ­£ã—ã„URLã§ã™ï¼‰
                </label>
                <button class="submit-btn" id="btnSendToTeacher" type="button" disabled>æå‡ºã™ã‚‹</button>
            </div>
        </div>

        <!-- ãƒ©ãƒ³ã‚¯ãƒ»ãƒˆãƒ­ãƒ•ã‚£ãƒ¼ -->
        <div class="section trophy-section">
            <h3>ç¾åœ¨ã®ãƒ©ãƒ³ã‚¯ã¨ãƒˆãƒ­ãƒ•ã‚£ãƒ¼</h3>
            {% with consecutive_days|default:0 as cd %}
                {% if cd <= 6 %}
                    <img src="{% static 'images/drank.jpg' %}" alt="Dãƒ©ãƒ³ã‚¯ãƒˆãƒ­ãƒ•ã‚£ãƒ¼">
                    <p>ç¾åœ¨é€£ç¶šãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚° {{ cd }}æ—¥ç›®ã€‚<br>Dãƒ©ãƒ³ã‚¯pitch masterï¼<br>é€£ç¶šãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°7æ—¥ç›®ã«Cãƒ©ãƒ³ã‚¯ã¸ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼</p>
                {% elif cd <= 29 %}
                    <img src="{% static 'images/crank.jpg' %}" alt="Cãƒ©ãƒ³ã‚¯ãƒˆãƒ­ãƒ•ã‚£ãƒ¼">
                    <p>ç¾åœ¨é€£ç¶šãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚° {{ cd }}æ—¥ç›®ã€‚<br>Cãƒ©ãƒ³ã‚¯pitch masterï¼<br>é€£ç¶šãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°30æ—¥ç›®ã«Bãƒ©ãƒ³ã‚¯ã¸ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼</p>
                {% elif cd <= 89 %}
                    <img src="{% static 'images/brank.jpg' %}" alt="Bãƒ©ãƒ³ã‚¯ãƒˆãƒ­ãƒ•ã‚£ãƒ¼">
                    <p>ç¾åœ¨é€£ç¶šãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚° {{ cd }}æ—¥ç›®ã€‚<br>Bãƒ©ãƒ³ã‚¯pitch masterï¼<br>é€£ç¶šãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°90æ—¥ç›®ã«Aãƒ©ãƒ³ã‚¯ã¸ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼</p>
                {% elif cd <= 179 %}
                    <img src="{% static 'images/arank.jpg' %}" alt="Aãƒ©ãƒ³ã‚¯ãƒˆãƒ­ãƒ•ã‚£ãƒ¼">
                    <p>ç¾åœ¨é€£ç¶šãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚° {{ cd }}æ—¥ç›®ã€‚<br>Aãƒ©ãƒ³ã‚¯pitch masterï¼<br>é€£ç¶šãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°180æ—¥ç›®ã«ãƒˆãƒƒãƒ—Sãƒ©ãƒ³ã‚¯ã¸ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼</p>
                {% else %}
                    <img src="{% static 'images/srank.jpg' %}" alt="Sãƒ©ãƒ³ã‚¯ãƒˆãƒ­ãƒ•ã‚£ãƒ¼">
                    <p>ç¾åœ¨é€£ç¶šãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚° {{ cd }}æ—¥ç›®ã€‚<br>è²´æ–¹ã¯ä»Šã€ãƒˆãƒƒãƒ—ãƒ©ãƒ³ã‚¯ãƒˆãƒ­ãƒ•ã‚£ãƒ¼ã‚’ç²å¾—ã—ã¦ã„ã‚‹Sãƒ©ãƒ³ã‚¯pitch masterã§ã™ã€‚</p>
                {% endif %}
            {% endwith %}
            <button class="share-btn" onclick="shareX()">çµæœã‚’Xã§ã‚·ã‚§ã‚¢</button>
            <p style="font-size:0.8rem; margin-top:5px;">ã€â€»æ¯æ—¥ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’ç¶šã‘ã‚‹ã“ã¨ã§ã€ãƒˆãƒ­ãƒ•ã‚£ãƒ¼ãŒãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ã—ã¾ã™ã€‚1æ—¥ã§ã‚‚ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’ä¸­æ­¢ã—ãŸå ´åˆã¯ã€ãƒ©ãƒ³ã‚¯å•ã‚ãšDãƒ©ãƒ³ã‚¯ã«ãƒ¬ãƒ™ãƒ«ãƒ€ã‚¦ãƒ³ã—ã¾ã™ã€‚ã€‘</p>
        </div>

        <!-- å…¨ãƒˆãƒ­ãƒ•ã‚£ãƒ¼ä¸€è¦§ -->
        <div class="section all-trophy">
            <h3>å…¨ãƒˆãƒ­ãƒ•ã‚£ãƒ¼ã®ç¨®é¡</h3>
            <img src="{% static 'images/all-trophy.jpg' %}" alt="å…¨ãƒˆãƒ­ãƒ•ã‚£ãƒ¼ä¸€è¦§">
        </div>

        <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
        <div class="controls">
           <a href="{% url 'game' %}?play=training_mode">
                <button type="button" class="game-btn">training mode ã® ã‚²ãƒ¼ãƒ ã¸</button>
            </a>
            <a href="{% url 'game2' %}?play=stage_mode">
                <button type="button" class="game-btn">stage mode ã® ã‚²ãƒ¼ãƒ ã¸</button>
            </a>
            <form id="logoutForm" method="post" action="{% url 'logout_view' %}">
                {% csrf_token %}
                <button type="button" class="logout-btn" onclick="handleLogout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </form>
        </div>

        <div id="logout-overlay">
            <img src="{% static 'images/otukare.PNG' %}" alt="ãŠç–²ã‚Œæ§˜">
        </div>

        <!-- ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div class="confirm-overlay" id="confirmOverlay">
            <div class="confirm-box">
                <h3>ã“ã®URLã§é€ä¿¡ã—ã¦ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ</h3>
                <p id="confirmUrlText" style="word-break:break-all;"></p>
                <p style="font-size:0.9rem;color:#ddd;">é€ä¿¡ã¯ã‚µãƒ¼ãƒãƒ¼çµŒç”±ã§è¡Œã‚ã‚Œã¾ã™ã€‚é€ä¿¡å†…å®¹ï¼šã“ã®ç”»é¢ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã€Œä»Šé€±ã®ä¸€é€±é–“åˆ†ã€ã®è¦ç´„ãƒ†ã‚­ã‚¹ãƒˆã‚’ã€æŒ‡å®šã®ãƒ•ã‚©ãƒ¼ãƒ ã«ã‚µãƒ¼ãƒãƒ¼å´ã§POSTã—ã¾ã™ã€‚</p>
                <div class="confirm-buttons">
                    <button class="small-btn secondary" id="confirmCancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button class="small-btn" id="confirmSend">é€ä¿¡ã™ã‚‹</button>
                </div>
            </div>
        </div>

        <script>
            document.addEventListener('DOMContentLoaded', function () {
                // ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³å‡¦ç†
                const headers = document.querySelectorAll('.day-header');
                headers.forEach(h => {
                    h.addEventListener('click', () => {
                        const idx = h.getAttribute('data-day-index');
                        const body = document.getElementById('day-body-' + idx);
                        if (!body) return;
                        const open = body.classList.contains('open');
                        if (open) {
                            body.style.maxHeight = '0';
                            body.classList.remove('open');
                        } else {
                            body.classList.add('open');
                            body.style.maxHeight = body.scrollHeight + 'px';
                        }
                    });
                });

                const bodies = document.querySelectorAll('.day-body');
                bodies.forEach(b => {
                    b.style.maxHeight = '0';
                });

                setupSimpleTeacherForm();
                document.getElementById('logout-overlay').style.display = 'none';
            });

            function shareX() {
                const consecutiveDays = parseInt("{{ consecutive_days|default:0 }}", 10) || 0;
                const trophyUrls = {
                    drank: "{% static 'images/drank.jpg' %}",
                    crank: "{% static 'images/crank.jpg' %}",
                    brank: "{% static 'images/brank.jpg' %}",
                    arank: "{% static 'images/arank.jpg' %}",
                    srank: "{% static 'images/srank.jpg' %}"
                };
                let chosen;
                if (consecutiveDays <= 6) {
                    chosen = trophyUrls.drank;
                } else if (consecutiveDays <= 29) {
                    chosen = trophyUrls.crank;
                } else if (consecutiveDays <= 89) {
                    chosen = trophyUrls.brank;
                } else if (consecutiveDays <= 179) {
                    chosen = trophyUrls.arank;
                } else {
                    chosen = trophyUrls.srank;
                }

                const text = `ğŸ‰ Pitch Masterã§ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°å ±å‘Š ğŸ‰\né€£ç¶šãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°: ${consecutiveDays}æ—¥ç›®\nãƒˆãƒ­ãƒ•ã‚£ãƒ¼: ${chosen}\n#pitchmaster`;
                const intentText = encodeURIComponent(text);
                const intentUrl = encodeURIComponent(chosen);
                const tweetIntent = `https://twitter.com/intent/tweet?text=${intentText}&url=${intentUrl}`;
                window.open(tweetIntent, "_blank");
            }

            function handleLogout() {
                const overlay = document.getElementById('logout-overlay');
                overlay.style.display = 'flex';
                setTimeout(() => {
                    document.getElementById('logoutForm').submit();
                }, 5000);
            }

            function getCookie(name) {
                const value = `; ${document.cookie}`;
                const parts = value.split(`; ${name}=`);
                if (parts.length === 2) return parts.pop().split(';').shift();
            }

            function setupSimpleTeacherForm() {
                const input = document.getElementById('teacherFormUrl');
                const consent = document.getElementById('consentCheckbox');
                const btnSend = document.getElementById('btnSendToTeacher');
                const confirmOverlay = document.getElementById('confirmOverlay');
                const confirmUrlText = document.getElementById('confirmUrlText');
                const confirmCancel = document.getElementById('confirmCancel');
                const confirmSend = document.getElementById('confirmSend');

                btnSend.disabled = true;

                input.addEventListener('input', updateButtonState);
                consent.addEventListener('change', updateButtonState);

                function updateButtonState() {
                    const url = (input.value || '').trim();
                    btnSend.disabled = !(isValidUrlFormat(url) && consent.checked);
                }

                btnSend.addEventListener('click', () => {
                    const url = (input.value || '').trim();
                    if (!isValidUrlFormat(url)) {
                        alert('URLå½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚http(s)ã§å§‹ã¾ã‚‹æ­£ã—ã„URLã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚');
                        return;
                    }
                    if (!consent.checked) {
                        alert('é€ä¿¡ã™ã‚‹å ´åˆã¯ã€ŒURLã«é–“é•ã„ã¯ã‚ã‚Šã¾ã›ã‚“ã€ã«ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚');
                        return;
                    }

                    confirmUrlText.textContent = url + '\n\n(é€ä¿¡å†…å®¹ã¯ç”»é¢ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã€Œä»Šé€±ã®ä¸€é€±é–“åˆ†ã€ã®è¦ç´„ãƒ†ã‚­ã‚¹ãƒˆã§ã™ã€‚ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚‚å«ã¾ã‚Œã¾ã™)';
                    confirmOverlay.style.display = 'flex';
                });

                confirmCancel.addEventListener('click', () => {
                    confirmOverlay.style.display = 'none';
                });

                confirmSend.addEventListener('click', async () => {
                    confirmOverlay.style.display = 'none';
                    const url = (input.value || '').trim();
                    const weekText = collectWeekSummaryText();
                    if (!weekText) {
                        alert('ä»Šé€±ã®è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚é€ä¿¡ã§ãã¾ã›ã‚“ã€‚');
                        return;
                    }

                    try {
                        const resp = await fetch('/api/submit_week_results/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': getCookie('csrftoken') || ''
                            },
                            body: JSON.stringify({
                                form_url: url,
                                week_summary: weekText,
                                username: "{{ user.username|escapejs }}",
                                week_hint: "é€±ï¼ˆæœˆã€œæ—¥ï¼‰"
                            })
                        });
                        if (!resp.ok) {
                            const txt = await resp.text().catch(()=>'');
                            alert('é€ä¿¡å¤±æ•—ï¼ˆã‚µãƒ¼ãƒãƒ¼å¿œç­”: ' + resp.status + 'ï¼‰ ' + txt);
                        } else {
                            const data = await resp.json().catch(()=>null);
                            if (data && data.ok) {
                                alert('é€ä¿¡æˆåŠŸ: ' + (data.message || 'å…ˆç”Ÿã®ãƒ•ã‚©ãƒ¼ãƒ ã«é€ä¿¡ã—ã¾ã—ãŸ'));
                            } else {
                                alert('é€ä¿¡å¤±æ•—: ' + (data && data.message ? data.message : 'ã‚µãƒ¼ãƒãƒ¼ãŒã‚¨ãƒ©ãƒ¼ã‚’è¿”ã—ã¾ã—ãŸ'));
                            }
                        }
                    } catch (e) {
                        alert('é€ä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼ˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã¾ãŸã¯ã‚µãƒ¼ãƒãƒ¼ï¼‰ã€‚');
                    }
                });

                function isValidUrlFormat(url) {
                    try {
                        const u = new URL(url);
                        if (!['http:', 'https:'].includes(u.protocol)) return false;
                        return true;
                    } catch (e) {
                        return false;
                    }
                }
            }

            function collectWeekSummaryText() {
                const dayBlocks = document.querySelectorAll('.week-accordion .day-block');
                if (!dayBlocks || dayBlocks.length === 0) return '';
                let lines = [];
                dayBlocks.forEach(db => {
                    const dateEl = db.querySelector('.day-title');
                    const title = dateEl ? dateEl.innerText.trim() : '';
                    const items = db.querySelectorAll('.week-item');
                    if (!items || items.length === 0) {
                        lines.push(`${title} â€” è¨˜éŒ²ãªã—`);
                    } else {
                        lines.push(`=== ${title} ===`);
                        items.forEach(it => {
                            lines.push(it.innerText.replace(/\s+/g,' ').trim());
                        });
                    }
                });
                return lines.join('\n');
            }

            function escapeHtml(str) {
                return str.replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]); });
            }
        </script>

    {% else %}
        <p>ã“ã®ãƒšãƒ¼ã‚¸ã¯ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã§ã™ã€‚</p>
    {% endif %}
</div>
</body>
</html>

<script>
window.addEventListener("load", function() {
    const params = new URLSearchParams(window.location.search);
    const play = params.get("play");
    if (play === "training_mode") {
        new Audio("{% static 'sounds/training_mode.mp3' %}").play();
    } else if (play === "stage_mode") {
        new Audio("{% static 'sounds/stage_mode.mp3' %}").play();
    }
});
</script>