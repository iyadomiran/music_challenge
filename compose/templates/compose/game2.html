{% load static %}
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ¢ãƒ¼ãƒ‰</title>
<link rel="stylesheet" href="{% static 'css/game2.css' %}">
</head>
<body class="game">
<h2>ğŸ¤  ----------------  Stage Mode ----------------  ğŸ¤</h2>
<div id="stage">
    <!-- ã‚¹ãƒ†ãƒ¼ã‚¸ç”»åƒï¼ˆæ­£èª¤ã§åˆ‡ã‚Šæ›¿ã‚ã‚‹ï¼‰ -->
    <img id="stageImage" src="{% static 'images/game2-tujyou.png' %}" alt="ã‚¹ãƒ†ãƒ¼ã‚¸ç”»åƒ">

    <!-- å•é¡Œãƒ†ã‚­ã‚¹ãƒˆ -->
    <h2 id="question">å•é¡Œã‚’èª­ã¿è¾¼ã¿ä¸­...</h2>

    <!-- ãƒ¡ãƒ­ãƒ‡ã‚£ãƒ¼å†ç”Ÿãƒœã‚¿ãƒ³ -->
    <button id="playMelody">å•é¡Œã®ãƒ¡ãƒ­ãƒ‡ã‚£ãƒ¼ã‚’è´ã</button>

    <!-- é¸æŠè‚¢æ¡ˆå†…æ–‡ -->
    <p id="choiceGuide">å›ç­”ï¼šä¸‹è¨˜ï¼“ã¤ã®é¸æŠè‚¢ã‹ã‚‰æ­£ã—ã„ã‚‚ã®ã‚’é¸ã¼ã†ï¼</p>

    <!-- é¸æŠè‚¢ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ -->
    <div id="choices"></div>

    <!-- æ­£èª¤çµæœ -->
    <p id="result" style="font-size:1.3em; margin-top:20px;"></p>

    <!-- å†ãƒãƒ£ãƒ¬ãƒ³ã‚¸ãƒœã‚¿ãƒ³ -->
    <button id="retry">å†åº¦å•é¡Œã«ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã™ã‚‹</button>
</div>

<!-- ä¸‹éƒ¨ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
<div id="nav">
    {% if user.is_authenticated and not user.username == "guest" %}
        <a href="{% url 'mypage' %}">ãƒã‚¤ãƒšãƒ¼ã‚¸</a>
    {% endif %}
    <a href="{% url 'rules' %}">ãƒ«ãƒ¼ãƒ«ç¢ºèª</a>
    <a href="{% url 'logout_view' %}">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
</div>

<script>
// ===== ãƒ¡ãƒ­ãƒ‡ã‚£ãƒ¼ã¨å•é¡Œãƒ‡ãƒ¼ã‚¿ =====
const quizData = {
    "{% static 'sounds/game2-1.mp3' %}": [
        { q: "æœ€åˆã®éŸ³ã¨æœ€å¾Œã®éŸ³ã¯ä½•åº¦ã®å·®ãŒã‚ã‚‹ã§ã—ã‚‡ã†ã€‚", options: ["1åº¦ã®å·®", "5åº¦ã®å·®", "0åº¦ã®å·®"], answer: "0åº¦ã®å·®" },
        { q: "æœ€åˆã‹ã‚‰4ç•ªç›®ã®éŸ³ã¨æœ€å¾Œã®éŸ³ã¯ä½•åº¦ã®å·®ãŒã‚ã‚‹ã§ã—ã‚‡ã†ã€‚", options: ["3åº¦ã®å·®", "7åº¦ã®å·®", "4åº¦ã®å·®"], answer: "4åº¦ã®å·®" },
        { q: "æœ€åˆã‹ã‚‰5ç•ªç›®ã®éŸ³ã¨æœ€åˆã‹ã‚‰8ç•ªç›®ã®éŸ³ã¯ä½•åº¦ã®å·®ãŒã‚ã‚‹ã§ã—ã‚‡ã†ã€‚", options: ["5åº¦ã®å·®", "4åº¦ã®å·®", "3åº¦ã®å·®"], answer: "4åº¦ã®å·®" }
    ],
    "{% static 'sounds/game2-2.mp3' %}": [
        { q: "æœ€åˆã®éŸ³ã¨æœ€åˆã‹ã‚‰ï¼“ç•ªç›®ã®éŸ³ã¯ä½•åº¦ã®å·®ãŒã‚ã‚‹ã§ã—ã‚‡ã†ã€‚", options: ["1åº¦ã®å·®", "5åº¦ã®å·®", "0åº¦ã®å·®"], answer: "5åº¦ã®å·®" },
        { q: "æœ€åˆã‹ã‚‰2ç•ªç›®ã®éŸ³ã¨æœ€å¾Œã®éŸ³ã¯ä½•åº¦ã®å·®ãŒã‚ã‚‹ã§ã—ã‚‡ã†ã€‚", options: ["3åº¦ã®å·®", "7åº¦ã®å·®", "4åº¦ã®å·®"], answer: "3åº¦ã®å·®" },
        { q: "æœ€åˆã‹ã‚‰3ç•ªç›®ã®éŸ³ã¨æœ€åˆã‹ã‚‰6ç•ªç›®ã®éŸ³ã¯ä½•åº¦ã®å·®ãŒã‚ã‚‹ã§ã—ã‚‡ã†ã€‚", options: ["2åº¦ã®å·®", "4åº¦ã®å·®", "3åº¦ã®å·®"], answer: "2åº¦ã®å·®" }
    ],
    "{% static 'sounds/game2-3.mp3' %}": [
        { q: "æœ€åˆã®éŸ³ã¨æœ€åˆã‹ã‚‰ã®2ç•ªç›®ã®éŸ³ã¯ä½•åº¦ã®å·®ãŒã‚ã‚‹ã§ã—ã‚‡ã†ã€‚", options: ["1åº¦ã®å·®", "5åº¦ã®å·®", "3åº¦ã®å·®"], answer: "3åº¦ã®å·®" },
        { q: "æœ€åˆã‹ã‚‰2ç•ªç›®ã®éŸ³ã¨æœ€å¾Œã®éŸ³ã¯ä½•åº¦ã®å·®ãŒã‚ã‚‹ã§ã—ã‚‡ã†ã€‚", options: ["3åº¦ã®å·®", "5åº¦ã®å·®", "4åº¦ã®å·®"], answer: "5åº¦ã®å·®" },
        { q: "æœ€åˆã®éŸ³ã¨æœ€å¾Œã®éŸ³ã¯ä½•åº¦ã®å·®ãŒã‚ã‚‹ã§ã—ã‚‡ã†ã€‚", options: ["5åº¦ã®å·®", "4åº¦ã®å·®", "3åº¦ã®å·®"], answer: "3åº¦ã®å·®" }
    ],
    "{% static 'sounds/game2-4.mp3' %}": [
        { q: "æœ€åˆã®éŸ³ã¨æœ€å¾Œã®éŸ³ã¯ä½•åº¦ã®å·®ãŒã‚ã‚‹ã§ã—ã‚‡ã†ã€‚", options: ["1åº¦ã®å·®", "5åº¦ã®å·®", "0åº¦ã®å·®"], answer: "0åº¦ã®å·®" },
        { q: "æœ€åˆã‹ã‚‰2ç•ªç›®ã®éŸ³ã¨æœ€å¾Œã®éŸ³ã¯ä½•åº¦ã®å·®ãŒã‚ã‚‹ã§ã—ã‚‡ã†ã€‚", options: ["3åº¦ã®å·®", "2åº¦ã®å·®", "4åº¦ã®å·®"], answer: "2åº¦ã®å·®" },
        { q: "æœ€åˆã®éŸ³ã¨æœ€åˆã‹ã‚‰4ç•ªç›®ã®éŸ³ã¯ä½•åº¦ã®å·®ãŒã‚ã‚‹ã§ã—ã‚‡ã†ã€‚", options: ["5åº¦ã®å·®", "4åº¦ã®å·®", "3åº¦ã®å·®"], answer: "5åº¦ã®å·®" }
    ],
    "{% static 'sounds/game2-5.mp3' %}": [
        { q: "æœ€åˆã®éŸ³ã¨æœ€å¾Œã®éŸ³ã¯ä½•åº¦ã®å·®ãŒã‚ã‚‹ã§ã—ã‚‡ã†ã€‚", options: ["6åº¦ã®å·®", "4åº¦ã®å·®", "0åº¦ã®å·®"], answer: "6åº¦ã®å·®" },
        { q: "æœ€åˆã‹ã‚‰2ç•ªç›®ã®éŸ³ã¨æœ€åˆã‹ã‚‰6ç•ªç›®ã®éŸ³ã¯ä½•åº¦ã®å·®ãŒã‚ã‚‹ã§ã—ã‚‡ã†ã€‚", options: ["3åº¦ã®å·®", "2åº¦ã®å·®", "4åº¦ã®å·®"], answer: "2åº¦ã®å·®" },
        { q: "æœ€åˆã®éŸ³ã¨æœ€åˆã‹ã‚‰3ç•ªç›®ã®éŸ³ã¯ä½•åº¦ã®å·®ãŒã‚ã‚‹ã§ã—ã‚‡ã†ã€‚", options: ["5åº¦ã®å·®", "4åº¦ã®å·®", "3åº¦ã®å·®"], answer: "3åº¦ã®å·®" }
    ],
    "{% static 'sounds/game2-6.mp3' %}": [
        { q: "æœ€åˆã®éŸ³ã¨æœ€å¾Œã®éŸ³ã¯ä½•åº¦ã®å·®ãŒã‚ã‚‹ã§ã—ã‚‡ã†ã€‚", options: ["1åº¦ã®å·®", "5åº¦ã®å·®", "0åº¦ã®å·®"], answer: "0åº¦ã®å·®" },
        { q: "æœ€åˆã‹ã‚‰3ç•ªç›®ã®éŸ³ã¨æœ€å¾Œã®éŸ³ã¯ä½•åº¦ã®å·®ãŒã‚ã‚‹ã§ã—ã‚‡ã†ã€‚", options: ["3åº¦ã®å·®", "7åº¦ã®å·®", "2åº¦ã®å·®"], answer: "2åº¦ã®å·®" },
        { q: "æœ€åˆã®éŸ³ã¨æœ€åˆã‹ã‚‰3ç•ªç›®ã®éŸ³ã¯ä½•åº¦ã®å·®ãŒã‚ã‚‹ã§ã—ã‚‡ã†ã€‚", options: ["5åº¦ã®å·®", "4åº¦ã®å·®", "3åº¦ã®å·®"], answer: "3åº¦ã®å·®" }
    ],
    "{% static 'sounds/game2-7.mp3' %}": [
        { q: "æœ€åˆã®éŸ³ã¨æœ€å¾Œã®éŸ³ã¯ä½•åº¦ã®å·®ãŒã‚ã‚‹ã§ã—ã‚‡ã†ã€‚", options: ["6åº¦ã®å·®", "8åº¦ã®å·®", "7åº¦ã®å·®"], answer: "8åº¦ã®å·®" },
        { q: "æœ€åˆã‹ã‚‰4ç•ªç›®ã®éŸ³ã¨æœ€å¾Œã®éŸ³ã¯ä½•åº¦ã®å·®ãŒã‚ã‚‹ã§ã—ã‚‡ã†ã€‚", options: ["3åº¦ã®å·®", "7åº¦ã®å·®", "6åº¦ã®å·®"], answer: "6åº¦ã®å·®" },
        { q: "æœ€åˆã®éŸ³ã¨æœ€åˆã‹ã‚‰5ç•ªç›®ã®éŸ³ã¯ä½•åº¦ã®å·®ãŒã‚ã‚‹ã§ã—ã‚‡ã†ã€‚", options: ["5åº¦ã®å·®", "2åº¦ã®å·®", "3åº¦ã®å·®"], answer: "2åº¦ã®å·®" }
    ]
};

let selectedMelody;
let selectedQuiz;

// ===== ã‚²ãƒ¼ãƒ åˆæœŸåŒ–é–¢æ•° =====
function initQuiz() {
    const melodies = Object.keys(quizData);
    selectedMelody = melodies[Math.floor(Math.random() * melodies.length)];
    selectedQuiz = quizData[selectedMelody][Math.floor(Math.random() * 3)];

    // å•é¡Œãƒ†ã‚­ã‚¹ãƒˆ
    document.getElementById("question").textContent = "å•é¡Œ : " + selectedQuiz.q;

    // é¸æŠè‚¢ãƒœã‚¿ãƒ³
    const choicesDiv = document.getElementById("choices");
    choicesDiv.innerHTML = ""; // æ—¢å­˜ãƒœã‚¿ãƒ³ã‚¯ãƒªã‚¢
    selectedQuiz.options.forEach(opt => {
        const btn = document.createElement("button");
        btn.textContent = opt;
        btn.style.margin = "10px";
        btn.style.backgroundColor = "#E7AA51";
        btn.style.color = "#ff2a2a";
        btn.style.border = "none";
        btn.style.borderRadius = "25px";
        btn.style.padding = "12px 28px";
        btn.style.fontSize = "20px";
        btn.style.fontWeight = "700";
        btn.style.cursor = "pointer";
        btn.onclick = () => checkAnswer(opt);
        choicesDiv.appendChild(btn);
    });

    // æ­£èª¤çµæœã‚¯ãƒªã‚¢
    document.getElementById("result").textContent = "";

    // å†ãƒãƒ£ãƒ¬ãƒ³ã‚¸ãƒœã‚¿ãƒ³éè¡¨ç¤º
    document.getElementById("retry").style.display = "none";

    // ç”»åƒã‚’é€šå¸¸ã«æˆ»ã™
    document.getElementById("stageImage").src = "{% static 'images/game2-tujyou.png' %}";
}

// ãƒ¡ãƒ­ãƒ‡ã‚£ãƒ¼å†ç”Ÿ
const melodyAudio = new Audio();
document.getElementById("playMelody").onclick = () => {
    melodyAudio.src = selectedMelody;
    melodyAudio.currentTime = 0;
    melodyAudio.play();
};

// æ­£èª¤åˆ¤å®š
function checkAnswer(selected) {
    const resultEl = document.getElementById("result");
    const stageImage = document.getElementById("stageImage");

    if (selected === selectedQuiz.answer) {
        resultEl.textContent = `æ­£è§£ï¼ç­”ãˆã¯ ${selectedQuiz.answer} ã§ã—ãŸï¼`;
        resultEl.style.color = "#fff8dc";
        stageImage.src = "{% static 'images/game2-seikai.png' %}";

        // ğŸ”Š æ­£è§£éŸ³ã‚’å†ç”Ÿ
        const correctSound = new Audio("{% static 'sounds/seikai.mp3' %}");
        correctSound.play();
    } else {
        resultEl.textContent = `ä¸æ­£è§£ï¼ç­”ãˆã¯ ${selectedQuiz.answer} ã§ã—ãŸã€‚`;
        resultEl.style.color = "#fff8dc";
        stageImage.src = "{% static 'images/game2-huseikai.png' %}";

        // ğŸ”Š ä¸æ­£è§£éŸ³ã‚’å†ç”Ÿ
        const wrongSound = new Audio("{% static 'sounds/oshii.mp3' %}");
        wrongSound.play();
    }

    // ãƒœã‚¿ãƒ³ç„¡åŠ¹åŒ–
    document.querySelectorAll("#choices button").forEach(b => b.disabled = true);

    // å†ãƒãƒ£ãƒ¬ãƒ³ã‚¸ãƒœã‚¿ãƒ³è¡¨ç¤º
    document.getElementById("retry").style.display = "inline-block";
}

// å†ãƒãƒ£ãƒ¬ãƒ³ã‚¸ãƒœã‚¿ãƒ³
document.getElementById("retry").onclick = () => {
    initQuiz();
};

// åˆå›èµ·å‹•
initQuiz();
</script>

</body>
</html>

<!-- éŸ³æºã‚’äº‹å‰ã«èª­ã¿è¾¼ã¿ -->
<audio id="training-audio" src="{% static 'sounds/training_mode.mp3' %}"></audio>
<audio id="stage-audio" src="{% static 'sounds/stage_mode.mp3' %}"></audio>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const params = new URLSearchParams(window.location.search);
    const sound = params.get("sound");

    if (sound === "training") {
        const audio = document.getElementById("training-audio");
        audio.play().catch(err => console.log("éŸ³å£°å†ç”Ÿã‚¨ãƒ©ãƒ¼:", err));
    } else if (sound === "stage") {
        const audio = document.getElementById("stage-audio");
        audio.play().catch(err => console.log("éŸ³å£°å†ç”Ÿã‚¨ãƒ©ãƒ¼:", err));
    }
});
</script>

<script>
window.addEventListener("load", function() {
    const params = new URLSearchParams(window.location.search);
    const play = params.get("play");
    if (play === "training_mode") {
        new Audio("{% static 'sounds/training_mode.mp3' %}").play();
    } else if (play === "stage_mode") {
        new Audio("{% static 'sounds/stage_mode.mp3' %}").play();
    }
});
</script>